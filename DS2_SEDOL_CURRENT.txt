/*
    @AUTHOR :   PRAVEEN KUMAR V
    @DESC   :   THIS QUERY RETRIEVES LATEST SEDOL FOR A GIVEN COMPANY
    
    @VER    :   V_0.01
  
    @EDITS  :   
  
*/
  
  
---- DATASTREAM MAPPING
WITH EXCHRERANK AS (SELECT *,ROW_NUMBER() OVER (PARTITION BY SECCODE,TYP,EXCHANGE ORDER BY [RANK] ASC) AS RERANK FROM (SELECT *,1 AS TYP FROM SECMAPX UNION SELECT *,6 AS TYP FROM GSECMAPX) P WHERE P.VENTYPE = 33)
   
, DS2MAPPING AS (SELECT SECCODE,TYP,[RANK],EXCHANGE,VENCODE FROM EXCHRERANK WHERE RERANK = 1)
  
SELECT U.ID
, U.IDENTIFIER
, U.COMPANYNAME
, C.INFOCODE
, (A.SEDOL+A.SEDOLCHK) AS SEDOL
  
  
FROM SUPPORT_DB.DBO.UNIVERSE U
LEFT JOIN DS2MAPPING B
    ON B.SECCODE=U.SECCODE 
    AND B.TYP=U.REGCODE 
    AND B.EXCHANGE = U.EXCHANGE 
LEFT JOIN DS2CTRYQTINFO C 
    ON C.INFOCODE = B.VENCODE
LEFT JOIN DS2SEDOLCHG A
	ON C.INFOCODE = A.INFOCODE 
	AND A.STARTDATE = (SELECT MAX(STARTDATE) FROM DS2SEDOLCHG WHERE INFOCODE = A.INFOCODE)  -- LATEST SEDOL